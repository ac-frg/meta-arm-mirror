From 381d3916beffa61b253317b671f48f87964c0ec3 Mon Sep 17 00:00:00 2001
From: Rui Miguel Silva <rui.silva@linaro.org>
Date: Wed, 14 Aug 2019 09:20:42 +0100
Subject: [PATCH 2/3] armv7: rename sp804 timer to mmio timer

Rename the wrongly init named mmio timer and fix the use of it on a
Cortex-A5 system that does not have arch_timer.

Signed-off-by: Usama Arif <usama.arif@arm.com>
Signed-off-by: Rui Miguel Silva <rui.silva@linaro.org>

%% original patch: 0001-armv7-rename-sp804-timer-to-mmio-timer.patch
---
 arch/arm/cpu/armv7/Makefile                    |  6 +-----
 .../cpu/armv7/{sp804_timer.c => mmio_timer.c}  | 18 ++++++++++--------
 scripts/config_whitelist.txt                   |  1 +
 3 files changed, 12 insertions(+), 13 deletions(-)
 rename arch/arm/cpu/armv7/{sp804_timer.c => mmio_timer.c} (71%)

diff --git a/arch/arm/cpu/armv7/Makefile b/arch/arm/cpu/armv7/Makefile
index 288d14732e..97727a0dbb 100644
--- a/arch/arm/cpu/armv7/Makefile
+++ b/arch/arm/cpu/armv7/Makefile
@@ -23,12 +23,8 @@ obj-$(CONFIG_ARMV7_PSCI)	+= psci.o psci-common.o
 obj-$(CONFIG_IPROC) += iproc-common/
 obj-$(CONFIG_KONA) += kona-common/
 
-SUPPORT_ARCH_TIMER    ?= yes
-ifeq ($(SUPPORT_ARCH_TIMER),no)
-obj-y += sp804_timer.o
-else
 obj-$(CONFIG_SYS_ARCH_TIMER) += arch_timer.o
-endif
+obj-$(CONFIG_SYS_MMIO_TIMER) += mmio_timer.o
 
 ifneq (,$(filter s5pc1xx exynos,$(SOC)))
 obj-y += s5p-common/
diff --git a/arch/arm/cpu/armv7/sp804_timer.c b/arch/arm/cpu/armv7/mmio_timer.c
similarity index 71%
rename from arch/arm/cpu/armv7/sp804_timer.c
rename to arch/arm/cpu/armv7/mmio_timer.c
index 9c1ecf3fa0..862587644f 100644
--- a/arch/arm/cpu/armv7/sp804_timer.c
+++ b/arch/arm/cpu/armv7/mmio_timer.c
@@ -11,23 +11,25 @@
 
 DECLARE_GLOBAL_DATA_PTR;
 
-#define SP804_TIMER0_BASE  UL(0x1C110000)
-#define SP804_TIMER1_VALUE_OFFSET UL(0x004)
+#define CNTCTLBASE UL(0x1a020000)
+#define CNTREADBASE UL(0x1a030000)
 
-int timer_init(void)
+static inline uint32_t mmio_read32(uintptr_t addr)
 {
-	gd->arch.timer_rate_hz = CONFIG_SYS_HZ_CLOCK / CONFIG_SYS_HZ;
-	return 0;
+	return *(volatile uint32_t*)addr;
 }
 
-static inline uint32_t mmio_read_32(uintptr_t addr)
+int timer_init(void)
 {
-	return *(volatile uint32_t*)addr;
+	gd->arch.timer_rate_hz = mmio_read32(CNTCTLBASE);
+
+	return 0;
 }
 
 unsigned long long get_ticks(void)
 {
-	return UINT_MAX - mmio_read_32(SP804_TIMER0_BASE + SP804_TIMER1_VALUE_OFFSET);
+	return ((mmio_read32(CNTCTLBASE + 0x4) << 32) |
+		mmio_read32(CNTREADBASE));
 }
 
 ulong get_timer(ulong base)
diff --git a/scripts/config_whitelist.txt b/scripts/config_whitelist.txt
index 95f27b6ead..e82e53cea3 100644
--- a/scripts/config_whitelist.txt
+++ b/scripts/config_whitelist.txt
@@ -3923,6 +3923,7 @@ CONFIG_SYS_MMC_U_BOOT_DST
 CONFIG_SYS_MMC_U_BOOT_OFFS
 CONFIG_SYS_MMC_U_BOOT_SIZE
 CONFIG_SYS_MMC_U_BOOT_START
+CONFIG_SYS_MMIO_TIMER
 CONFIG_SYS_MONITOR_
 CONFIG_SYS_MONITOR_BASE
 CONFIG_SYS_MONITOR_BASE_EARLY
-- 
2.17.1

